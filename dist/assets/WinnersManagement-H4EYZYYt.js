import{d as X,r as o,j as e,T as z}from"./index-BWKLWp2a.js";import{a as b}from"./api-CQpZrRPq.js";import{P as Z}from"./PageTitle-DL7ojCXH.js";import"./iconify-n91bYVR1.js";import{R as E}from"./Row-V7i5xCpB.js";import{C}from"./Col-C4wMi2v-.js";import{C as M}from"./Card-CWWYwgtx.js";import{F as a}from"./Form-B53MJkKZ.js";import{B as j}from"./Button-Dv0UYMmi.js";import{S as Y}from"./Spinner-CdSHaVLM.js";import{T as _}from"./Table-DeKJQtPO.js";import{B as ee}from"./Badge-D1XIvkjl.js";import{M as m}from"./Modal-DCjXyMUz.js";import"./CardHeaderContext-CGj4Ymt7.js";import"./divWithClassName-D2fuI0u2.js";import"./FormCheck-DtPc7GjH.js";import"./FormContext-4W2HT6MH.js";import"./FormCheckInput-B8900dye.js";import"./ElementChildren-Bf8dG_zA.js";import"./FormControl-C4UrPRDY.js";import"./FormLabel-C-mxrP7_.js";import"./Button-C6xMcIFL.js";import"./AbstractModalHeader-Cj6HN8us.js";import"./useWindow-CgjI47pI.js";import"./usePrevious-BQjOGUf2.js";import"./useEventCallback-625_xS6O.js";import"./hasClass-Dsb8l2C3.js";import"./useMergedRefs-BNQwCw-c.js";import"./NoopTransition-BYS5XlVR.js";import"./DataKey-COGXBUcQ.js";const Ye=()=>{const{programId:f}=X(),[c,k]=o.useState(null),[g,u]=o.useState(!1),[G,p]=o.useState(!1),[P,h]=o.useState(""),[A,T]=o.useState([]),[x,v]=o.useState([]),[R,w]=o.useState(!1),[L,$]=o.useState(null),[q,I]=o.useState(!1),[s,S]=o.useState(null),[i,D]=o.useState({month:"",year:new Date().getFullYear(),lotId:"",prizeAmount:""}),F=["January","February","March","April","May","June","July","August","September","October","November","December"],N=()=>{if(!c)return[];const t=new Date(c.startDate).getFullYear(),n=c.endDate?new Date(c.endDate).getFullYear():new Date().getFullYear(),r=[];for(let l=t;l<=n+1;l++)r.push(l);return r},H=[...new Set(x.map(t=>t.year))].sort((t,n)=>n-t),[W,B]=o.useState(H[0]||new Date().getFullYear());o.useEffect(()=>{(async()=>{var n;u(!0);try{const[r,l]=await Promise.all([b.get(`/gold/${f}`),b.get(`/gold/${f}/lots?eligibleOnly=true`)]);k(r.data.data),v(r.data.data.winners||[]);const d=new Set((r.data.data.winners||[]).map(y=>y.lotId));T(l.data.data.filter(y=>!d.has(y.id))),(n=r.data.data.winners)!=null&&n.length||B(new Date().getFullYear())}catch(r){console.error("Error fetching data:",r),h("Failed to load program data"),p(!0)}finally{u(!1)}})()},[f]);const J=async t=>{var r,l;if(t.preventDefault(),!i.month||!i.lotId||!i.year){h("Month, year and lot selection are required"),p(!0);return}if(x.find(d=>d.month===parseInt(i.month)&&d.year===parseInt(i.year))){h("This month/year combination already has a winner"),p(!0);return}u(!0);try{const d=await b.post("/gold/winners",{programId:f,winners:[{...i,month:parseInt(i.month),year:parseInt(i.year)}]});v([...x,...d.data.data]),T(y=>y.filter(V=>V.id!==parseInt(i.lotId))),h("Winner added successfully!"),D({month:"",year:new Date().getFullYear(),lotId:"",prizeAmount:""})}catch(d){h(((l=(r=d.response)==null?void 0:r.data)==null?void 0:l.message)||"Failed to add winner"),p(!0)}finally{u(!1)}},O=t=>{S(t),I(!0)},U=async()=>{var t,n;if(!s.month||!s.lotId||!s.year){h("Month, year and lot selection are required"),p(!0);return}u(!0);try{const r=await b.put(`/gold/winners/${s.id}`,{month:parseInt(s.month),year:parseInt(s.year),lotId:parseInt(s.lotId),prizeAmount:s.prizeAmount,programId:s.programId});v(x.map(l=>l.id===s.id?r.data.data:l)),h("Winner updated successfully!"),I(!1)}catch(r){h(((n=(t=r.response)==null?void 0:t.data)==null?void 0:n.message)||"Failed to update winner"),p(!0)}finally{u(!1)}},K=t=>{$(t),w(!0)},Q=async()=>{var t,n;u(!0);try{await b.delete(`/gold/winners/${L.id}`),v(x.filter(r=>r.id!==L.id)),h("Winner deleted successfully"),w(!1)}catch(r){h(((n=(t=r.response)==null?void 0:t.data)==null?void 0:n.message)||"Failed to delete winner"),p(!0)}finally{u(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx(Z,{title:`Winners - ${(c==null?void 0:c.name)||"Loading..."}`,breadcrumbItems:[{label:"Gold Programs",path:"/gold-programs"},{label:(c==null?void 0:c.name)||"Program",path:`/gold-programs/${f}`},{label:"Winners Management",active:!0}]}),e.jsx(z,{onClose:()=>p(!1),show:G,delay:3e3,autohide:!0,style:{position:"fixed",top:20,right:20,zIndex:9999},children:e.jsx(z.Body,{children:P})}),e.jsxs(E,{children:[e.jsx(C,{md:6,children:e.jsx(M,{className:"mb-4",children:e.jsxs(M.Body,{children:[e.jsx("h5",{children:"Add New Winner"}),e.jsxs(a,{onSubmit:J,children:[e.jsxs(E,{children:[e.jsx(C,{md:6,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Year*"}),e.jsx(a.Select,{value:i.year,onChange:t=>D({...i,year:t.target.value}),required:!0,children:N().map(t=>e.jsx("option",{value:t,children:t},t))})]})}),e.jsx(C,{md:6,children:e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Month*"}),e.jsxs(a.Select,{value:i.month,onChange:t=>D({...i,month:t.target.value}),required:!0,children:[e.jsx("option",{value:"",children:"Select month..."}),F.map((t,n)=>e.jsx("option",{value:n+1,children:t},t))]})]})})]}),e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Select Lot*"}),e.jsxs(a.Select,{value:i.lotId,onChange:t=>D({...i,lotId:t.target.value}),required:!0,children:[e.jsx("option",{value:"",children:"Choose lot..."}),A.map(t=>{var n,r;return e.jsxs("option",{value:t.id,children:[(n=t.user)==null?void 0:n.name," (Member ID: ",(r=t.user)==null?void 0:r.memberId,")"]},t.id)})]})]}),e.jsx(j,{type:"submit",variant:"primary",disabled:g,children:g?e.jsx(Y,{size:"sm",animation:"border"}):"Add Winner"})]})]})})}),e.jsx(C,{md:6,children:e.jsx(M,{children:e.jsxs(M.Body,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("h5",{children:"Current Winners"}),e.jsx(a.Select,{style:{width:"120px"},value:W,onChange:t=>B(parseInt(t.target.value)),children:N().map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs(_,{striped:!0,hover:!0,responsive:!0,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Month"}),e.jsx("th",{children:"Winner"}),e.jsx("th",{children:"Member ID"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:x.filter(t=>t.year===W).sort((t,n)=>t.month-n.month).map(t=>{var n,r,l,d;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(ee,{bg:"info",children:F[t.month-1]})}),e.jsx("td",{children:((r=(n=t.lot)==null?void 0:n.user)==null?void 0:r.name)||"N/A"}),e.jsx("td",{children:((d=(l=t.lot)==null?void 0:l.user)==null?void 0:d.memberId)||"N/A"}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(j,{variant:"primary",size:"sm",onClick:()=>O(t),disabled:g,children:"Edit"}),e.jsx(j,{variant:"danger",size:"sm",onClick:()=>K(t),disabled:g,children:"Delete"})]})})]},t.id)})})]}),x.filter(t=>t.year===W).length===0&&e.jsxs("div",{className:"text-center py-4 text-muted",children:["No winners for ",W]})]})})})]}),e.jsxs(m,{show:q,onHide:()=>I(!1),children:[e.jsx(m.Header,{closeButton:!0,children:e.jsx(m.Title,{children:"Edit Winner"})}),e.jsx(m.Body,{children:s&&e.jsxs(a,{children:[e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Year"}),e.jsx(a.Select,{value:s.year,onChange:t=>S({...s,year:t.target.value}),children:N().map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Month"}),e.jsx(a.Select,{value:s.month,onChange:t=>S({...s,month:t.target.value}),children:F.map((t,n)=>e.jsx("option",{value:n+1,children:t},t))})]}),e.jsxs(a.Group,{className:"mb-3",children:[e.jsx(a.Label,{children:"Lot"}),e.jsx(a.Select,{value:s.lotId,onChange:t=>S({...s,lotId:t.target.value}),children:A.concat(x.filter(t=>t.id===s.id).map(t=>t.lot)).map(t=>{var n,r;return e.jsxs("option",{value:t.id,children:[(n=t.user)==null?void 0:n.name," (Member ID: ",(r=t.user)==null?void 0:r.memberId,")"]},t.id)})})]})]})}),e.jsxs(m.Footer,{children:[e.jsx(j,{variant:"secondary",onClick:()=>I(!1),children:"Cancel"}),e.jsx(j,{variant:"primary",onClick:U,children:g?e.jsx(Y,{size:"sm",animation:"border"}):"Update Winner"})]})]}),e.jsxs(m,{show:R,onHide:()=>w(!1),centered:!0,children:[e.jsx(m.Header,{closeButton:!0,children:e.jsx(m.Title,{children:"Confirm Deletion"})}),e.jsx(m.Body,{children:"Are you sure you want to delete this winner? This action cannot be undone."}),e.jsxs(m.Footer,{children:[e.jsx(j,{variant:"secondary",onClick:()=>w(!1),children:"Cancel"}),e.jsx(j,{variant:"danger",onClick:Q,children:g?e.jsx(Y,{size:"sm",animation:"border"}):"Delete Winner"})]})]})]})};export{Ye as default};
