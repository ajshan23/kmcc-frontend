import{u as J,r as o,j as e,T as D}from"./index-D9C8xGDJ.js";import{a as C}from"./api-CQpZrRPq.js";import{P as K}from"./PageTitle-CTV_nOCB.js";import{I as M}from"./IconifyIcon-B_FaLXx1.js";import{M as g}from"./Modal-CL_CNIw1.js";import{B as p}from"./Button-jzwfO54I.js";import{R as Q,C as W}from"./Row-DNXGtDaS.js";import{C as z}from"./Card-Bg5eLJtX.js";import{F as d}from"./Form-B7ZRRNa0.js";import{I as X}from"./InputGroup-Wt55S580.js";import{S as k}from"./Spinner-CvNOHT_H.js";import{B as L}from"./ListGroup-Bd_qI1C3.js";import{B as Z}from"./Badge-lUxFseza.js";import"./iconify-D7I9lgUj.js";import"./AbstractModalHeader-B0m5d8Cx.js";import"./useWindow-B79ER2bB.js";import"./usePrevious-DlNrynkd.js";import"./useEventCallback-CSjVCyuo.js";import"./hasClass-DiruUP4K.js";import"./useMergedRefs-ChISKg02.js";import"./NoopTransition-CoSkVbwQ.js";import"./DataKey-COGXBUcQ.js";import"./divWithClassName-2VyLv_7K.js";import"./Button-_Yz-NvGp.js";import"./CardHeaderContext-B6CePyy5.js";import"./FormCheck-CFPqw4o6.js";import"./FormContext-D-yD9u-c.js";import"./ElementChildren-DgCQtZUg.js";import"./FormControl-DWlS3GFR.js";import"./FormLabel-BEDtgQcg.js";import"./InputGroupContext-YvM13c4v.js";import"./hook-C3BOm-4g.js";import"./extends-CF3RwP-h.js";import"./Nav-CXlgxRYC.js";import"./NavContext-B1rVRbJL.js";import"./NavItem-36seL4NA.js";const Le=()=>{var F;const y=J(),[i,u]=o.useState({submit:!1,users:!1,checking:!1}),[$,h]=o.useState(!1),[q,x]=o.useState(""),[v,b]=o.useState({userId:"",initialDeposit:""}),[f,S]=o.useState(""),[w,T]=o.useState([]),[r,N]=o.useState(null),[G,j]=o.useState(!1),[E,I]=o.useState(!1),[a,H]=o.useState(null);o.useEffect(()=>{const s=async()=>{var c,t,l,B;if(!f.trim()){T([]),j(!1);return}try{u(Y=>({...Y,users:!0}));const m=await C.get(`/admin/users?search=${f}`);(t=(c=m.data)==null?void 0:c.data)!=null&&t.users&&(T(m.data.data.users),j(!0))}catch(m){console.error("Error fetching users:",m),x(((B=(l=m.response)==null?void 0:l.data)==null?void 0:B.message)||"Failed to load users"),h(!0)}finally{u(m=>({...m,users:!1}))}},n=setTimeout(()=>{s()},300);return()=>clearTimeout(n)},[f]);const P=()=>{f&&w.length>0&&j(!0)},R=()=>{setTimeout(()=>{j(!1)},200)},U=s=>{N(s),b(n=>({...n,userId:s.id.toString()})),S(`${s.name} (${s.memberId})`),j(!1)};o.useEffect(()=>{r!=null&&r.id&&A(r.id)},[r]);const A=async s=>{var n,c;try{u(l=>({...l,checking:!0}));const t=await C.get("/investments/check-active",{params:{userId:s}});t.data.data.hasActiveInvestment&&(H(t.data.data.activeInvestment),I(!0))}catch(t){x(((c=(n=t.response)==null?void 0:n.data)==null?void 0:c.message)||"Failed to check existing investments"),h(!0)}finally{u(t=>({...t,checking:!1}))}},V=async s=>{var n,c;if(s.preventDefault(),!r){x("Please select a user"),h(!0);return}try{u(l=>({...l,submit:!0}));const t=await C.post("/investments",{userId:r.id,initialDeposit:v.initialDeposit?parseFloat(v.initialDeposit):void 0});x("Investment created successfully!"),h(!0),setTimeout(()=>y(`/investments/${t.data.data.id}`),1500)}catch(t){let l="Failed to create investment";(c=(n=t.response)==null?void 0:n.data)!=null&&c.message&&(l=t.response.data.message),x(l),h(!0)}finally{u(t=>({...t,submit:!1}))}},O=()=>{a!=null&&a.id&&y(`/investments/${a.id}`),I(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(K,{title:"New Investment",breadcrumbItems:[{label:"Investments",path:"/investments"},{label:"New Investment",active:!0}]}),e.jsxs(D,{onClose:()=>h(!1),show:$,delay:5e3,autohide:!0,style:{position:"fixed",top:20,right:20,zIndex:9999},children:[e.jsx(D.Header,{children:e.jsx("strong",{className:"me-auto",children:"Notification"})}),e.jsx(D.Body,{children:q})]}),e.jsxs(g,{show:E,onHide:()=>I(!1),children:[e.jsx(g.Header,{closeButton:!0,children:e.jsx(g.Title,{children:"Existing Active Investment"})}),e.jsxs(g.Body,{children:[e.jsx("p",{children:"This user already has an active investment:"}),e.jsxs("ul",{children:[e.jsxs("li",{children:["ID: ",a==null?void 0:a.id]}),e.jsxs("li",{children:["Started:"," ",new Date(a==null?void 0:a.startDate).toLocaleDateString()]}),e.jsxs("li",{children:["Total Deposited: $",(F=a==null?void 0:a.totalDeposited)==null?void 0:F.toLocaleString()]})]}),e.jsx("p",{children:"Please close the existing investment before creating a new one."})]}),e.jsxs(g.Footer,{children:[e.jsx(p,{variant:"secondary",onClick:()=>I(!1),children:"Cancel"}),e.jsx(p,{variant:"primary",onClick:O,children:"View Existing Investment"})]})]}),e.jsx(Q,{children:e.jsx(W,{md:6,children:e.jsx(z,{children:e.jsx(z.Body,{children:e.jsxs(d,{onSubmit:V,children:[e.jsxs(d.Group,{className:"mb-3",controlId:"userSearch",children:[e.jsx(d.Label,{children:"Select Member*"}),e.jsxs("div",{style:{position:"relative"},children:[e.jsxs(X,{children:[e.jsx(d.Control,{type:"text",placeholder:"Start typing name, member ID or iqama",value:f,onChange:s=>{S(s.target.value),s.target.value===""&&(N(null),b(n=>({...n,userId:""})))},onFocus:P,onBlur:R,disabled:i.submit||i.checking,autoComplete:"off"}),e.jsx(p,{variant:"outline-secondary",disabled:i.users||i.submit||i.checking,children:i.users?e.jsx(k,{size:"sm",animation:"border"}):e.jsx(M,{icon:"mdi:magnify"})})]}),G&&w.length>0&&e.jsx(L,{style:{position:"absolute",zIndex:1e3,width:"100%",maxHeight:"300px",overflowY:"auto",boxShadow:"0 4px 8px rgba(0,0,0,0.1)"},children:w.map(s=>e.jsx(L.Item,{action:!0,onMouseDown:n=>n.preventDefault(),onClick:()=>U(s),style:{cursor:"pointer"},children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("strong",{children:s.name}),e.jsxs("div",{className:"text-muted small",children:[e.jsxs("span",{className:"me-2",children:["ID: ",s.memberId]}),e.jsxs("span",{children:["Iqama: ",s.iqamaNumber]})]})]}),e.jsx(Z,{bg:"primary",children:s.phoneNumber})]})},s.id))})]}),i.checking&&e.jsxs("div",{className:"mt-2",children:[e.jsx(k,{size:"sm",animation:"border"})," Checking for existing investments..."]})]}),r&&e.jsx("div",{className:"mb-3 p-3 bg-light rounded",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h6",{className:"mb-1",children:r.name}),e.jsxs("div",{className:"text-muted small",children:[e.jsxs("span",{className:"me-2",children:["Member ID: ",r.memberId]}),e.jsxs("span",{children:["Iqama: ",r.iqamaNumber]})]})]}),e.jsx(p,{variant:"outline-danger",size:"sm",onClick:()=>{N(null),S(""),b(s=>({...s,userId:""}))},disabled:i.checking,children:e.jsx(M,{icon:"mdi:close"})})]})}),e.jsxs(d.Group,{className:"mb-3",children:[e.jsx(d.Label,{children:"Initial Deposit (Optional)"}),e.jsx(d.Control,{type:"number",step:"0.01",placeholder:"Enter amount",value:v.initialDeposit,onChange:s=>b({...v,initialDeposit:s.target.value}),disabled:i.submit||i.checking})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(p,{variant:"secondary",onClick:()=>y("/investments"),disabled:i.submit||i.checking,children:"Cancel"}),e.jsx(p,{type:"submit",variant:"primary",disabled:i.submit||i.checking||!r||E,children:i.submit?e.jsxs(e.Fragment,{children:[e.jsx(k,{size:"sm",animation:"border",className:"me-2"}),"Creating..."]}):"Create Investment"})]})]})})})})})]})};export{Le as default};
