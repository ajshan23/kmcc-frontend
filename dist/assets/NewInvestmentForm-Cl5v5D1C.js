import{u as J,r as o,j as e,T as C}from"./index-tNgA7nGT.js";import{a as D}from"./api-CQpZrRPq.js";import{P as K}from"./PageTitle-CCkfjASR.js";import{I as M}from"./IconifyIcon-s9Hyo8eO.js";import{M as b}from"./Modal-XWv4zo73.js";import{B as x}from"./Button-CENta7Bz.js";import{R as Q}from"./Row-RifMysLS.js";import{C as W}from"./Col-CnORAU6q.js";import{C as L}from"./Card-B1tYBRGQ.js";import{F as l}from"./Form-Dv6oRs5P.js";import{I as X}from"./InputGroup-sUvZEEcM.js";import{S as k}from"./Spinner-DN05z5fI.js";import{B as z}from"./ListGroup-DO98VgCp.js";import{B as Z}from"./Badge-6r31o3T3.js";import"./iconify-RXcx2lhF.js";import"./AbstractModalHeader-_KRINFje.js";import"./useWindow-BY7h8nM3.js";import"./usePrevious-BewAhWrh.js";import"./useEventCallback-pYaJC5nB.js";import"./hasClass-B91NjqlQ.js";import"./useMergedRefs-CqwwmTTk.js";import"./NoopTransition-CWzBALoK.js";import"./DataKey-COGXBUcQ.js";import"./divWithClassName-BkIstr-m.js";import"./Button-CXeEohPr.js";import"./CardHeaderContext-BtYRO3IT.js";import"./FormCheck-Bgt48iIR.js";import"./FormContext-DD_I2OzJ.js";import"./FormCheckInput-B2vMIfyo.js";import"./ElementChildren-DV_13d0k.js";import"./FormControl-CbvVdWru.js";import"./FormLabel-C90nlSEw.js";import"./InputGroupContext-DdlMQU-e.js";import"./hook-BrFPO8J7.js";import"./extends-CF3RwP-h.js";import"./Nav-vMb328M1.js";import"./NavContext-Df65UCKh.js";import"./NavItem-YpGF5LpO.js";const qe=()=>{var F;const y=J(),[t,h]=o.useState({submit:!1,users:!1,checking:!1}),[$,p]=o.useState(!1),[q,f]=o.useState(""),[d,j]=o.useState({userId:"",initialDeposit:"",notes:""}),[g,S]=o.useState(""),[w,T]=o.useState([]),[r,N]=o.useState(null),[G,v]=o.useState(!1),[E,I]=o.useState(!1),[i,H]=o.useState(null);o.useEffect(()=>{const s=async()=>{var m,a,c,B;if(!g.trim()){T([]),v(!1);return}try{h(Y=>({...Y,users:!0}));const u=await D.get(`/admin/users?search=${g}`);(a=(m=u.data)==null?void 0:m.data)!=null&&a.users&&(T(u.data.data.users),v(!0))}catch(u){console.error("Error fetching users:",u),f(((B=(c=u.response)==null?void 0:c.data)==null?void 0:B.message)||"Failed to load users"),p(!0)}finally{h(u=>({...u,users:!1}))}},n=setTimeout(()=>{s()},300);return()=>clearTimeout(n)},[g]);const P=()=>{g&&w.length>0&&v(!0)},R=()=>{setTimeout(()=>{v(!1)},200)},U=s=>{N(s),j(n=>({...n,userId:s.id.toString()})),S(`${s.name} (${s.memberId})`),v(!1)};o.useEffect(()=>{r!=null&&r.id&&A(r.id)},[r]);const A=async s=>{var n,m;try{h(c=>({...c,checking:!0}));const a=await D.get("/investments/check-active",{params:{userId:s}});a.data.data.hasActiveInvestment&&(H(a.data.data.activeInvestment),I(!0))}catch(a){f(((m=(n=a.response)==null?void 0:n.data)==null?void 0:m.message)||"Failed to check existing investments"),p(!0)}finally{h(a=>({...a,checking:!1}))}},O=async s=>{var n,m;if(s.preventDefault(),!r){f("Please select a user"),p(!0);return}try{h(c=>({...c,submit:!0}));const a=await D.post("/investments",{userId:r.id,initialDeposit:d.initialDeposit?parseFloat(d.initialDeposit):void 0,notes:d.notes||void 0});f("Investment created successfully!"),p(!0),setTimeout(()=>y(`/investments/${a.data.data.id}`),1500)}catch(a){let c="Failed to create investment";(m=(n=a.response)==null?void 0:n.data)!=null&&m.message&&(c=a.response.data.message),f(c),p(!0)}finally{h(a=>({...a,submit:!1}))}},V=()=>{i!=null&&i.id&&y(`/investments/${i.id}`),I(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(K,{title:"New Investment",breadcrumbItems:[{label:"Investments",path:"/investments"},{label:"New Investment",active:!0}]}),e.jsxs(C,{onClose:()=>p(!1),show:$,delay:5e3,autohide:!0,style:{position:"fixed",top:20,right:20,zIndex:9999},children:[e.jsx(C.Header,{children:e.jsx("strong",{className:"me-auto",children:"Notification"})}),e.jsx(C.Body,{children:q})]}),e.jsxs(b,{show:E,onHide:()=>I(!1),children:[e.jsx(b.Header,{closeButton:!0,children:e.jsx(b.Title,{children:"Existing Active Investment"})}),e.jsxs(b.Body,{children:[e.jsx("p",{children:"This user already has an active investment:"}),e.jsxs("ul",{children:[e.jsxs("li",{children:["ID: ",i==null?void 0:i.id]}),e.jsxs("li",{children:["Started:"," ",new Date(i==null?void 0:i.startDate).toLocaleDateString()]}),e.jsxs("li",{children:["Total Deposited: $",(F=i==null?void 0:i.totalDeposited)==null?void 0:F.toLocaleString()]})]}),e.jsx("p",{children:"Please close the existing investment before creating a new one."})]}),e.jsxs(b.Footer,{children:[e.jsx(x,{variant:"secondary",onClick:()=>I(!1),children:"Cancel"}),e.jsx(x,{variant:"primary",onClick:V,children:"View Existing Investment"})]})]}),e.jsx(Q,{children:e.jsx(W,{md:6,children:e.jsx(L,{children:e.jsx(L.Body,{children:e.jsxs(l,{onSubmit:O,children:[e.jsxs(l.Group,{className:"mb-3",controlId:"userSearch",children:[e.jsx(l.Label,{children:"Select Member*"}),e.jsxs("div",{style:{position:"relative"},children:[e.jsxs(X,{children:[e.jsx(l.Control,{type:"text",placeholder:"Start typing name, member ID or iqama",value:g,onChange:s=>{S(s.target.value),s.target.value===""&&(N(null),j(n=>({...n,userId:""})))},onFocus:P,onBlur:R,disabled:t.submit||t.checking,autoComplete:"off"}),e.jsx(x,{variant:"outline-secondary",disabled:t.users||t.submit||t.checking,children:t.users?e.jsx(k,{size:"sm",animation:"border"}):e.jsx(M,{icon:"mdi:magnify"})})]}),G&&w.length>0&&e.jsx(z,{style:{position:"absolute",zIndex:1e3,width:"100%",maxHeight:"300px",overflowY:"auto",boxShadow:"0 4px 8px rgba(0,0,0,0.1)"},children:w.map(s=>e.jsx(z.Item,{action:!0,onMouseDown:n=>n.preventDefault(),onClick:()=>U(s),style:{cursor:"pointer"},children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("strong",{children:s.name}),e.jsxs("div",{className:"text-muted small",children:[e.jsxs("span",{className:"me-2",children:["ID: ",s.memberId]}),e.jsxs("span",{children:["Iqama: ",s.iqamaNumber]})]})]}),e.jsx(Z,{bg:"primary",children:s.phoneNumber})]})},s.id))})]}),t.checking&&e.jsxs("div",{className:"mt-2",children:[e.jsx(k,{size:"sm",animation:"border"})," Checking for existing investments..."]})]}),r&&e.jsx("div",{className:"mb-3 p-3 bg-light rounded",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h6",{className:"mb-1",children:r.name}),e.jsxs("div",{className:"text-muted small",children:[e.jsxs("span",{className:"me-2",children:["Member ID: ",r.memberId]}),e.jsxs("span",{children:["Iqama: ",r.iqamaNumber]})]})]}),e.jsx(x,{variant:"outline-danger",size:"sm",onClick:()=>{N(null),S(""),j(s=>({...s,userId:""}))},disabled:t.checking,children:e.jsx(M,{icon:"mdi:close"})})]})}),e.jsxs(l.Group,{className:"mb-3",children:[e.jsx(l.Label,{children:"Initial Deposit (Optional)"}),e.jsx(l.Control,{type:"number",step:"0.01",placeholder:"Enter amount",value:d.initialDeposit,onChange:s=>j({...d,initialDeposit:s.target.value}),disabled:t.submit||t.checking})]}),e.jsxs(l.Group,{className:"mb-3",children:[e.jsx(l.Label,{children:"Notes (Optional)"}),e.jsx(l.Control,{as:"textarea",rows:3,placeholder:"Enter any notes about this initial deposit",value:d.notes,onChange:s=>j({...d,notes:s.target.value}),disabled:t.submit||t.checking})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>y("/investments"),disabled:t.submit||t.checking,children:"Cancel"}),e.jsx(x,{type:"submit",variant:"primary",disabled:t.submit||t.checking||!r||E,children:t.submit?e.jsxs(e.Fragment,{children:[e.jsx(k,{size:"sm",animation:"border",className:"me-2"}),"Creating..."]}):"Create Investment"})]})]})})})})})]})};export{qe as default};
