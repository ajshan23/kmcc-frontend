import{d as te,r as c,j as e,T as k,R as re}from"./index-CWxK9h8P.js";import{a as W}from"./api-CQpZrRPq.js";import{P as ne}from"./PageTitle-DWsonpDE.js";import"./iconify-BL2rH4cv.js";import{R as G}from"./Row-C2I4GQ41.js";import{C as N}from"./Col-BXHEcCf6.js";import{C as F}from"./Card-DZFDkilJ.js";import{F as s}from"./Form-3aqpnuqS.js";import{B as g}from"./Button-CQasjNBg.js";import{S as B}from"./Spinner-Dqj128jD.js";import{T as ae}from"./Table-DywIZmfJ.js";import{B as R}from"./Badge-BJiw47KL.js";import{M as h}from"./Modal-BvhR9nwq.js";import"./CardHeaderContext-ijBDOs9Q.js";import"./divWithClassName-B3-UALgE.js";import"./FormCheck-BSjGQnoS.js";import"./FormContext-COJ5zA0n.js";import"./FormCheckInput-DXPhqNpk.js";import"./ElementChildren-C4XOSt_6.js";import"./FormControl-CAjNTUps.js";import"./FormLabel-CcqgsKZl.js";import"./Button-Rbr09trj.js";import"./AbstractModalHeader-Dg8cC4yC.js";import"./useWindow-BSjvxul1.js";import"./usePrevious-f1lRgY9w.js";import"./useEventCallback-FbBVX3K_.js";import"./hasClass-Ce-Nhihp.js";import"./useMergedRefs-7j0TLQWM.js";import"./NoopTransition-N-W7GiHR.js";import"./DataKey-COGXBUcQ.js";const Te=()=>{const{programId:y}=te(),[m,q]=c.useState(null),[f,x]=c.useState(!1),[H,j]=c.useState(!1),[J,u]=c.useState(""),[E,L]=c.useState([]),[p,D]=c.useState([]),[O,A]=c.useState(!1),[b,U]=c.useState(null),[K,z]=c.useState(!1),[l,v]=c.useState(null),[o,w]=c.useState({month:"",year:new Date().getFullYear(),lotId:"",prizeAmount:""}),Y=["January","February","March","April","May","June","July","August","September","October","November","December"],T=()=>{if(!m)return[];const t=new Date(m.startDate).getFullYear(),n=m.endDate?new Date(m.endDate).getFullYear():new Date().getFullYear(),r=[];for(let a=t;a<=n+1;a++)r.push(a);return r},Q=[...new Set(p.map(t=>t.year))].sort((t,n)=>n-t),[M,P]=c.useState(Q[0]||new Date().getFullYear());c.useEffect(()=>{(async()=>{var n;x(!0);try{const[r,a]=await Promise.all([W.get(`/gold/${y}`),W.get(`/gold/${y}/lots?eligibleOnly=true`)]);q(r.data.data),D(r.data.data.winners||[]);const i=new Set((r.data.data.winners||[]).map(d=>d.lotId));L(a.data.data.filter(d=>!i.has(d.id))),(n=r.data.data.winners)!=null&&n.length||P(new Date().getFullYear())}catch(r){console.error("Error fetching data:",r),u("Failed to load program datass"),j(!0)}finally{x(!1)}})()},[y]);const V=async t=>{var n,r;if(t.preventDefault(),!o.month||!o.lotId||!o.year){u("Month, year and lot selection are required"),j(!0);return}x(!0);try{const a=await W.post("/gold/winners",{programId:y,winners:[{...o,month:parseInt(o.month),year:parseInt(o.year)}]});D([...p,...a.data.data]),L(i=>i.filter(d=>d.id!==parseInt(o.lotId))),u("Winner added successfully!"),w({month:"",year:new Date().getFullYear(),lotId:"",prizeAmount:""})}catch(a){u(((r=(n=a.response)==null?void 0:n.data)==null?void 0:r.message)||"Failed to add winner"),j(!0)}finally{x(!1)}},X=t=>{v(t),z(!0)},Z=async()=>{var t,n;if(!l.month||!l.lotId||!l.year){u("Month, year and lot selection are required"),j(!0);return}x(!0);try{const r=await W.put(`/gold/winners/${l.id}`,{month:parseInt(l.month),year:parseInt(l.year),lotId:parseInt(l.lotId),prizeAmount:l.prizeAmount,programId:l.programId});D(p.map(a=>a.id===l.id?r.data.data:a)),u("Winner updated successfully!"),z(!1)}catch(r){u(((n=(t=r.response)==null?void 0:t.data)==null?void 0:n.message)||"Failed to update winner"),j(!0)}finally{x(!1)}},_=t=>{U(t),A(!0)},ee=async()=>{var t,n,r;x(!0);try{if(await W.delete(`/gold/winners/${b.id}`),D(p.filter(i=>i.id!==b.id)),!p.some(i=>i.lotId===b.lotId&&i.id!==b.id)){const i=(t=p.find(d=>d.id===b.id))==null?void 0:t.lot;i&&L(d=>[...d,i])}u("Winner deleted successfully"),A(!1)}catch(a){u(((r=(n=a.response)==null?void 0:n.data)==null?void 0:r.message)||"Failed to delete winner"),j(!0)}finally{x(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx(ne,{title:`Winners - ${(m==null?void 0:m.name)||"Loading..."}`,breadcrumbItems:[{label:"Gold Programs",path:"/gold-programs"},{label:(m==null?void 0:m.name)||"Program",path:`/gold-programs/${y}`},{label:"Winners Management",active:!0}]}),e.jsx(k,{onClose:()=>j(!1),show:H,delay:3e3,autohide:!0,style:{position:"fixed",top:20,right:20,zIndex:9999},children:e.jsx(k.Body,{children:J})}),e.jsxs(G,{children:[e.jsx(N,{md:6,children:e.jsx(F,{className:"mb-4",children:e.jsxs(F.Body,{children:[e.jsx("h5",{children:"Add New Winner"}),e.jsxs(s,{onSubmit:V,children:[e.jsxs(G,{children:[e.jsx(N,{md:6,children:e.jsxs(s.Group,{className:"mb-3",children:[e.jsx(s.Label,{children:"Year*"}),e.jsx(s.Select,{value:o.year,onChange:t=>w({...o,year:t.target.value}),required:!0,children:T().map(t=>e.jsx("option",{value:t,children:t},t))})]})}),e.jsx(N,{md:6,children:e.jsxs(s.Group,{className:"mb-3",children:[e.jsx(s.Label,{children:"Month*"}),e.jsxs(s.Select,{value:o.month,onChange:t=>w({...o,month:t.target.value}),required:!0,children:[e.jsx("option",{value:"",children:"Select month..."}),Y.map((t,n)=>e.jsx("option",{value:n+1,children:t},t))]})]})})]}),e.jsxs(s.Group,{className:"mb-3",children:[e.jsx(s.Label,{children:"Select Lot*"}),e.jsxs(s.Select,{value:o.lotId,onChange:t=>w({...o,lotId:t.target.value}),required:!0,children:[e.jsx("option",{value:"",children:"Choose lot..."}),E.map(t=>{var n,r;return e.jsxs("option",{value:t.id,children:[(n=t.user)==null?void 0:n.name," (Member ID: ",(r=t.user)==null?void 0:r.memberId,")"]},t.id)})]})]}),e.jsxs(s.Group,{className:"mb-3",children:[e.jsx(s.Label,{children:"Prize Amount (Optional)"}),e.jsx(s.Control,{type:"number",placeholder:"Enter prize amount",value:o.prizeAmount,onChange:t=>w({...o,prizeAmount:t.target.value})})]}),e.jsx(g,{type:"submit",variant:"primary",disabled:f,children:f?e.jsx(B,{size:"sm",animation:"border"}):"Add Winner"})]})]})})}),e.jsx(N,{md:6,children:e.jsx(F,{children:e.jsxs(F.Body,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("h5",{children:"Current Winners"}),e.jsx(s.Select,{style:{width:"120px"},value:M,onChange:t=>P(parseInt(t.target.value)),children:T().map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs(ae,{striped:!0,hover:!0,responsive:!0,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Month"}),e.jsx("th",{children:"Winner(s)"}),e.jsx("th",{children:"Member ID"}),e.jsx("th",{children:"Prize Amount"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:Y.map((t,n)=>{const r=p.filter(a=>a.year===M&&a.month===n+1).sort((a,i)=>{var d,S,I,C,$;return($=(S=(d=a.lot)==null?void 0:d.user)==null?void 0:S.name)==null?void 0:$.localeCompare((C=(I=i.lot)==null?void 0:I.user)==null?void 0:C.name)});return r.length===0?null:e.jsx(re.Fragment,{children:r.map((a,i)=>{var d,S,I,C;return e.jsxs("tr",{children:[i===0&&e.jsx("td",{rowSpan:r.length,children:e.jsxs(R,{bg:"info",children:[t," ",e.jsx(R,{bg:"light",text:"dark",children:r.length})]})}),e.jsx("td",{children:((S=(d=a.lot)==null?void 0:d.user)==null?void 0:S.name)||"N/A"}),e.jsx("td",{children:((C=(I=a.lot)==null?void 0:I.user)==null?void 0:C.memberId)||"N/A"}),e.jsx("td",{children:a.prizeAmount?`$${a.prizeAmount}`:"N/A"}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(g,{variant:"primary",size:"sm",onClick:()=>X(a),disabled:f,children:"Edit"}),e.jsx(g,{variant:"danger",size:"sm",onClick:()=>_(a),disabled:f,children:"Delete"})]})})]},`${n}-${i}`)})},n)})})]}),p.filter(t=>t.year===M).length===0&&e.jsxs("div",{className:"text-center py-4 text-muted",children:["No winners for ",M]})]})})})]}),e.jsxs(h,{show:K,onHide:()=>z(!1),children:[e.jsx(h.Header,{closeButton:!0,children:e.jsx(h.Title,{children:"Edit Winner"})}),e.jsx(h.Body,{children:l&&e.jsxs(s,{children:[e.jsxs(s.Group,{className:"mb-3",children:[e.jsx(s.Label,{children:"Year"}),e.jsx(s.Select,{value:l.year,onChange:t=>v({...l,year:t.target.value}),children:T().map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs(s.Group,{className:"mb-3",children:[e.jsx(s.Label,{children:"Month"}),e.jsx(s.Select,{value:l.month,onChange:t=>v({...l,month:t.target.value}),children:Y.map((t,n)=>e.jsx("option",{value:n+1,children:t},t))})]}),e.jsxs(s.Group,{className:"mb-3",children:[e.jsx(s.Label,{children:"Lot"}),e.jsx(s.Select,{value:l.lotId,onChange:t=>v({...l,lotId:t.target.value}),children:E.concat(p.filter(t=>t.id===l.id).map(t=>t.lot)).map(t=>{var n,r;return e.jsxs("option",{value:t.id,children:[(n=t.user)==null?void 0:n.name," (Member ID: ",(r=t.user)==null?void 0:r.memberId,")"]},t.id)})})]}),e.jsxs(s.Group,{className:"mb-3",children:[e.jsx(s.Label,{children:"Prize Amount"}),e.jsx(s.Control,{type:"number",value:l.prizeAmount||"",onChange:t=>v({...l,prizeAmount:t.target.value}),placeholder:"Enter prize amount"})]})]})}),e.jsxs(h.Footer,{children:[e.jsx(g,{variant:"secondary",onClick:()=>z(!1),children:"Cancel"}),e.jsx(g,{variant:"primary",onClick:Z,children:f?e.jsx(B,{size:"sm",animation:"border"}):"Update Winner"})]})]}),e.jsxs(h,{show:O,onHide:()=>A(!1),centered:!0,children:[e.jsx(h.Header,{closeButton:!0,children:e.jsx(h.Title,{children:"Confirm Deletion"})}),e.jsx(h.Body,{children:"Are you sure you want to delete this winner? This action cannot be undone."}),e.jsxs(h.Footer,{children:[e.jsx(g,{variant:"secondary",onClick:()=>A(!1),children:"Cancel"}),e.jsx(g,{variant:"danger",onClick:ee,children:f?e.jsx(B,{size:"sm",animation:"border"}):"Delete Winner"})]})]})]})};export{Te as default};
